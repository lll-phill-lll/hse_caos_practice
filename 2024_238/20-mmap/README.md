# 13 Семинар 21.02.2023 mmap

## Файлики с кодом:

* [Примар работы mmap](mmap_example.c)
* [Несколько процессов работют с mmap](mmap_multiple_processes.c)
* [Провоцируем OOM-killer (запускать осторожно)](kill_proc.c)

# mmap

```
#include <sys/mman.h>

void *mmap(
    void *addr,    /* рекомендуемый адрес отображения, можно передавать NULL, если адрес не важен */
    size_t length, /* размер отображения */
    int prot,      /* аттрибуты доступа */
    int flags,     /* флаги совместного отображения */
    int fd,        /* файловый дескриптор файла */
    off_t offset   /* смещение относительно начала файла */
  );

int munmap(void *addr, size_t length) /* освободить отображение */

```

При ошибке `mmap` возвращает специальное значение `MAP_FAILED`.
Чтобы детектировать ошибку, нужно проверять возвращаемое значение не на `NULL`,
а на `MAP_FAILED`

## Значения prot:

	 PROT_NONE   Pages may not be accessed.
     PROT_READ   Pages may be read.
     PROT_WRITE  Pages may be written.
     PROT_EXEC   Pages may be executed.

Использовать с битовым или: `PROT_READ | PROT_WRITE`

## Значения flags:

* `MAP_FIXED` - требует, чтобы память была выделена по указаному в первом аргументе адресу; без этого флага ядро может выбрать адрес, наиболее близкий к указанному.
* `MAP_ANONYMOUS` - выделить страницы в оперативной памяти, а не связать с файлом. В таком случае значение файлового дескриптора игнорируется.
* `MAP_SHARED` - выделить страницы, разделяемые с другими процессами; в случае с отображением на файл - синхронизировать изменения так, чтобы они были доступны другим процессам.
* `MAP_PRIVATE` - в противоположность `MAP_SHARED`, не делать отображение доступным другим процессам. В случае отображения на файл, он доступен для чтения, а созданные процессом изменения, в файл не сохраняются.

